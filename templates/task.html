{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/theme/material.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/python/python.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
<script>
let visibleTests = [];

// Функция для генерации заготовки кода
function generateCodeTemplate() {
    return `def solve():
    # Ваша реализация здесь
    pass
    if __name__ == "__main__":
        result = solve()
        print(result)`;
}

// Функция для загрузки списка тестов через API
function loadTaskTests() {
    fetch(`/api/task/{{ task_name }}/tests`)
    .then(response => response.json())
    .then(data => {
        visibleTests = data.visible_tests || [];
        loadSubmissions();
    })
    .catch(error => {
        console.error('Ошибка при загрузке списка тестов:', error);
        alert('Произошла ошибка при загрузке списка тестов.');
    });
}

// Функция для загрузки данных о посылках через API
function loadSubmissions() {
    fetch('/api/submissions')
    .then(response => response.json())
    .then(data => {
        const submissionsList = document.getElementById('submissions-list');
        submissionsList.innerHTML = '';
        const filteredSubmissions = data.filter(submission => submission.task_name === '{{ task_name }}');
        filteredSubmissions.forEach((submission, submissionIndex) => {
            const submissionDiv = document.createElement('div');
            submissionDiv.className = 'submission';
            const submissionHeader = document.createElement('div');
            submissionHeader.className = 'submission-header';
            submissionHeader.innerHTML = `
                <span>Посылка ${submissionIndex + 1} | Дата и времени: ${submission.timestamp}</span>
                <span>Баллы: ${submission.score}</span>
                <button>Подробнее</button>
            `;
            submissionHeader.onclick = () => toggleDetails(`details-${submissionIndex}`);
            const submissionDetails = document.createElement('div');
            submissionDetails.id = `details-${submissionIndex}`;
            submissionDetails.className = 'submission-details';
            submissionDetails.style.display = 'none';
            const codeHeader = document.createElement('h3');
            codeHeader.textContent = 'Код';
            const codePre = document.createElement('pre');
            codePre.textContent = submission.code || 'Код отсутствует';
            submissionDetails.appendChild(codeHeader);
            submissionDetails.appendChild(codePre);
            submissionDiv.appendChild(submissionHeader);
            submissionDiv.appendChild(submissionDetails);
            submissionsList.appendChild(submissionDiv);
        });
    })
    .catch(error => {
        console.error('Ошибка при загрузке данных:', error);
        alert('Произошла ошибка при загрузке данных.');
    });
}

// Функции для раскрытия/скрытия деталей
function toggleDetails(id) {
    const details = document.getElementById(id);
    details.style.display = details.style.display === 'none' ? 'block' : 'none';
}

// Инициализация CodeMirror с заготовкой кода
document.addEventListener('DOMContentLoaded', async () => {
    const template = generateCodeTemplate();
    const editor = CodeMirror.fromTextArea(document.getElementById('code-input'), {
        value: template,
        mode: 'python',
        lineNumbers: true,
        theme: 'material',
        indentUnit: 4
    });
    loadTaskTests();
});
</script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }
    .markdown-body {
        padding: 20px;
        border-radius: 5px;
    }
    pre {
        background-color: #333;
        padding: 10px;
        border-radius: 5px;
        overflow: auto;
    }
    code {
        background-color: #444;
        padding: 2px 4px;
        border-radius: 3px;
    }
    .taskn{
        margin-left: 20px;
        color: #3e5974;
    }
</style>

<h2 class="taskn">Задача# {{ taskn }}</h2>
<div class="markdown-body" id="description">{{ description }}</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
<script>
    const markdownText = document.getElementById('description').textContent;
    const htmlContent = marked(markdownText);
    document.getElementById('description').innerHTML = htmlContent;
</script>

<!-- Форма для отправки кода -->
<form id="code-form" method="POST">
    <textarea id="code-input" name="code" rows="20" cols="80" placeholder="Введите ваш код"></textarea><br>
    <input type="hidden" name="task_name" value="{{ task_name }}">
    <input type="submit" value="Отправить">
</form>
<!-- Список посылок -->
<h2>Посылки</h2>
<div id="submissions-list">
    <!-- Список посылок будет загружен сюда через JavaScript -->
</div>
{% endblock %}