<!-- login.html -->
{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='reg-log.css') }}">
<div class="form-container">
    <div class="card">
        <div class="card2">
            <form class="form" method="POST" id="loginForm">
                <p id="heading">Вход</p>
                <div class="field">
                    <svg class="input-icon" width="30" height="24" viewBox="0 0 24 24" fill="#00000000" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M4 14H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M15 14H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14.8191 14.0261C14.6079 14.6063 14.2228 15.1072 13.7164 15.4605C13.21 15.8137 12.607 16.0021 11.9895 16C11.3721 15.9978 10.7703 15.8052 10.2664 15.4484C9.76251 15.0916 9.38095 14.588 9.17383 14.0064" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" class="input-field" placeholder="Email или имя пользователя" name="identifier" required autocomplete="off" />
                </div>
                <div class="field">
                    <svg class="input-icon" width="30" height="24" viewBox="0 0 24 24" fill="#00000000" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 9V6C16 4.34315 14.6569 3 13 3H11C9.34315 3 8 4.34315 8 6V9M16 9H8M16 9C17.6569 9 19 10.3431 19 12V18C19 19.6569 17.6569 21 16 21H8C6.34315 21 5 19.6569 5 18V12C5 10.3431 6.34315 9 8 9M12 14V17M13 14C13 14.5523 12.5523 15 12 15C11.4477 15 11 14.5523 11 14C11 13.4477 11.4477 13 12 13C12.5523 13 13 13.4477 13 14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="password" class="input-field" placeholder="Пароль" name="password" required />
                </div>
                <div class="btn">
                    <button class="button1" type="submit"><div class="intext">Войти</div><span class="button1-shadow"></span></button>
                </div>
                <p class="btext">Нет аккаунта? <a href="{{ url_for('auth.register') }}">Зарегистрироваться</a></p>
                <a class="button3" href="{{ url_for('auth.forgot_password') }}">Забыли пароль?</a>
            </form>
        </div>
    </div>
</div>

<!-- Оверлей для выбора аккаунта -->
<div id="accountOverlay" class="account-overlay">
    <div class="account-container">
        <h2>Выберите аккаунт</h2>
        <div id="accountList" class="account-list"></div>
        <p class="account-note">Показаны только аккаунты, соответствующие введенным email и паролю.</p>
    </div>
</div>

<script>
    document.addEventListener('mousemove', (e) => {
        document.body.style.setProperty('--mouse-x', `${e.clientX}px`);
        document.body.style.setProperty('--mouse-y', `${e.clientY}px`);
    });

    const button = document.querySelector('.button1');
    if (button) {
        let styleSheet = document.createElement('style');
        document.head.appendChild(styleSheet);
        let spotlightRuleIndex;
        let shadowRuleIndex;
        let entryEdge = null;

        button.addEventListener('mouseenter', (e) => {
            const rect = button.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const fromLeft = x < rect.width / 2 && x <= 10;
            const fromRight = x > rect.width / 2 && x >= rect.width - 10;
            const fromTop = y < rect.height / 2 && y <= 10;
            const fromBottom = y > rect.height / 2 && y >= rect.height - 10;

            if (fromLeft) entryEdge = 'left';
            else if (fromRight) entryEdge = 'right';
            else if (fromTop) entryEdge = 'top';
            else if (fromBottom) entryEdge = 'bottom';
        });

        button.addEventListener('mousemove', (e) => {
            const rect = button.getBoundingClientRect();
            const spotlightSize = 30;
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (!styleSheet.sheet.cssRules.length || !spotlightRuleIndex) {
                spotlightRuleIndex = styleSheet.sheet.insertRule(
                    `.button1::after { left: ${x}px; top: ${y}px; opacity: 0.8; }`,
                    0
                );
            } else {
                styleSheet.sheet.deleteRule(spotlightRuleIndex);
                spotlightRuleIndex = styleSheet.sheet.insertRule(
                    `.button1::after { left: ${x}px; top: ${y}px; opacity: 0.8; }`,
                    0
                );
            }

            let shadowX, shadowY;
            const shadowSize = 50;
            if (entryEdge === 'left') {
                shadowX = -shadowSize;
                shadowY = y;
            } else if (entryEdge === 'right') {
                shadowX = rect.width;
                shadowY = y;
            } else if (entryEdge === 'top') {
                shadowX = x;
                shadowY = -shadowSize;
            } else if (entryEdge === 'bottom') {
                shadowX = x;
                shadowY = rect.height;
            }

            if (shadowRuleIndex !== undefined) {
                styleSheet.sheet.deleteRule(shadowRuleIndex);
            }
            shadowRuleIndex = styleSheet.sheet.insertRule(
                `.button1-shadow { left: ${shadowX}px; top: ${shadowY}px; opacity: 0.5; }`,
                spotlightRuleIndex + 1
            );
        });

        button.addEventListener('mouseleave', () => {
            if (styleSheet.sheet.cssRules.length && spotlightRuleIndex !== undefined) {
                styleSheet.sheet.deleteRule(spotlightRuleIndex);
                spotlightRuleIndex = styleSheet.sheet.insertRule(
                    `.button1::after { opacity: 0; }`,
                    0
                );
            }

            if (shadowRuleIndex !== undefined) {
                styleSheet.sheet.deleteRule(shadowRuleIndex);
                shadowRuleIndex = undefined;
            }
            entryEdge = null;
        });
    }

    // Обработка формы входа
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch('{{ url_for("auth.login") }}', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.status === 'success') {
            window.location.href = result.redirect;
        } else if (result.status === 'select') {
            const accountList = document.getElementById('accountList');
            accountList.innerHTML = '';
            result.users.forEach(user => {
                const accountCard = document.createElement('div');
                accountCard.className = 'account-card';
                accountCard.dataset.userId = user.id;
                accountCard.innerHTML = `<span>${user.username}</span>`;
                accountCard.addEventListener('click', () => selectAccount(user.id));
                accountList.appendChild(accountCard);
            });
            document.getElementById('accountOverlay').style.display = 'flex';
            document.querySelector('.form-container').style.filter = 'blur(5px)';
        } else {
            alert(result.message);
        }
    });

    async function selectAccount(userId) {
        const formData = new FormData();
        formData.append('user_id', userId);

        const response = await fetch('{{ url_for("auth.select_account") }}', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.status === 'success') {
            window.location.href = result.redirect;
        } else {
            alert(result.message);
        }
    }
</script>
{% endblock %}