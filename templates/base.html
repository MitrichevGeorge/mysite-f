<!DOCTYPE html>
<html class="{% if is_dark_theme %}dark{% else %}light{% endif %}"></html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Контест{% endblock %}</title>
    {% if is_dark_theme %}
        <link rel="stylesheet" href="{{ url_for('static', filename='base_styles_dark.css') }}">
    {% else %}
        <link rel="stylesheet" href="{{ url_for('static', filename='base_styles_light.css') }}">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='base_styles.css') }}">
    
    <script>
        window.onscroll = function() {
            const header = document.getElementById("header");
            const childElements = header.querySelectorAll('*');

            if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
                header.classList.add("scrolled");
                childElements.forEach(child => {
                    child.classList.add("scrolled");
                });
            } else {
                header.classList.remove("scrolled");
                childElements.forEach(child => {
                    child.classList.remove("scrolled");
                });
            }
        };
    </script>
    <style>
        :root {
            --is-dark-theme: {{ 'true' if is_dark_theme else 'false' }};
        }
    </style>
</head>
<body>
    <div class="flash-container" id="flash-container"></div>
    <header id="header">
        <a href="/" class="logo">Главная</a>
        <div class="tabs" id="tabs">
            <div class="shdw-left" id="noscroll"></div>
            {% for tab in tabs %}
                <div class="tab" onclick="window.location.href='{{ tab.url }}'">
                    {{ tab.name }} <span class="close" onclick="removeTab('{{ tab.name }}')">✖</span>
                </div>
            {% endfor %}
            <div class="shdw-right" id="noscroll"></div>
        </div>
        <div class="auth-links">
            {% if current_user.is_authenticated %}
                <a class="tbtt" href="/profile">Личный кабинет ({{ current_user.username }})</a>
                <a class="tbtt" href="/logout">Выйти</a>
            {% else %}
                <a class="tbtt" href="/login">Вход/Регистрация</a>
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
            <div class="user-name" id="user-name">
                {{ current_user.username }}
            </div>
            <div class="dropdown" id="user-dropdown" style="display: none;">
                <a href="/profile">Профиль</a>
                <a href="/logout">Выход</a>
            </div>
        {% endif %}
    </header>
    {% if current_user.is_authenticated %}
    <script>
        document.querySelectorAll('.close').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the tab click event
                const tabName = this.previousElementSibling.textContent; // Get the tab title
                removeTab(tabName); // Call the function to remove the tab
            });
        });

        function removeTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            let tabIndex = -1;
        
            tabs.forEach((tab, index) => {
                if (tab.textContent.includes(tabName)) {
                    tabIndex = index;
                }
            });
        
            if (tabIndex !== -1) {
                fetch(`/api/del_tab/${tabIndex}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const tabToRemove = tabs[tabIndex];
                    tabToRemove.remove();
                    console.log('Updated tabs:', data);
                })
                .catch(error => {
                    console.error('Error removing tab:', error);
                });
            }
        }
    </script>
    <script>
        const scrollContainer = document.getElementById('tabs');
        const noScrollElements = document.querySelectorAll('#noscroll');
        console.log(noScrollElements);
        scrollContainer.addEventListener('scroll', () => {
            const { scrollLeft, scrollWidth, clientWidth } = scrollContainer;
            const isAtStart = scrollLeft === 0;
            const isAtEnd = Math.ceil(scrollLeft + clientWidth) >= scrollWidth;

            if (isAtStart) {
                scrollContainer.classList.remove('show-left-shadow');
            } else {
                scrollContainer.classList.add('show-left-shadow');
            }

            if (isAtEnd) {
                scrollContainer.classList.remove('show-right-shadow');
            } else {
                scrollContainer.classList.add('show-right-shadow');
            }
            noScrollElements.forEach((element) => {
                const rect = element.getBoundingClientRect();
                const containerRect = scrollContainer.getBoundingClientRect();
                
                element.style.transform = `translateX(${scrollContainer.scrollLeft}px)`;
                element.style.top = `${rect.top - containerRect.top}px`;
            });
        });
    </script>
    {% endif %}
    <main>
        {% block content %}{% endblock %}
    </main>
    {% if current_user.is_authenticated %}
    <script>
        const userName = document.getElementById('user-name');
        const userDropdown = document.getElementById('user-dropdown');

        userName.addEventListener('click', function() {
            userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
            userDropdown.style.left = `${userName.offsetLeft-100}px`; // Позиционируем по горизонтали
            userDropdown.style.top = `${userName.offsetTop + userName.offsetHeight}px`; // Позиционируем по вертикали
        });

        // Скрываем выпадающий список при уходе курсора с шапки или списка
        userName.addEventListener('mouseleave', function() {
            setTimeout(() => {
                if (!userDropdown.matches(':hover')) {
                    userDropdown.style.display = 'none';
                }
            }, 100); // Задержка для предотвращения мгновенного исчезновения
        });

        userDropdown.addEventListener('mouseleave', function() {
            userDropdown.style.display = 'none';
        });
    </script>
    {% endif %}
    <script>
        function showFlashMessage(message, category = 'info') {
            const flashContainer = document.getElementById('flash-container');
            const flashDiv = document.createElement('div');
            flashDiv.className = `flash-message ${category}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close';
            closeBtn.innerHTML = '✖';
            
            const timerBar = document.createElement('div');
            timerBar.className = 'timer-bar';
            
            const expandArrow = document.createElement('div');
            expandArrow.className = 'expand-arrow';
            expandArrow.innerHTML = '↓';
            
            flashDiv.appendChild(contentDiv);
            flashDiv.appendChild(closeBtn);
            flashDiv.appendChild(timerBar);
            flashDiv.appendChild(expandArrow);
            
            flashContainer.prepend(flashDiv);
            
            // Проверка на многострочность
            const lineHeight = parseInt(getComputedStyle(contentDiv).lineHeight);
            const contentHeight = contentDiv.offsetHeight;
            if (contentHeight > lineHeight * 4) {
                flashDiv.classList.add('show-arrow');
            }
            
            // Обработчик клика по стрелке
            expandArrow.addEventListener('click', () => {
                flashDiv.classList.toggle('expanded');
                expandArrow.innerHTML = flashDiv.classList.contains('expanded') ? '↑' : '↓';
            });
            
            // Обработчик закрытия
            closeBtn.addEventListener('click', () => {
                flashDiv.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    flashDiv.remove();
                }, 300);
            });
            
            // Таймер исчезновения (5 секунд)
            setTimeout(() => {
                if (flashDiv.parentNode) {
                    flashDiv.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        flashDiv.remove();
                    }, 300);
                }
            }, 5000);
        }
    </script>
    <script>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showFlashMessage('{{ message | safe }}', '{{ category }}');
                {% endfor %}
            {% endif %}
        {% endwith %}
    </script>
</body>
</html>