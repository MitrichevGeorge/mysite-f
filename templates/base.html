<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Контест{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base_styles_light.css') }}">
    
    <script>
        window.onscroll = function() {
            const header = document.getElementById("header");
            const childElements = header.querySelectorAll('*');

            if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
                header.classList.add("scrolled");
                childElements.forEach(child => {
                    child.classList.add("scrolled");
                });
            } else {
                header.classList.remove("scrolled");
                childElements.forEach(child => {
                    child.classList.remove("scrolled");
                });
            }
        };
    </script>
</head>
<body>
    <header id="header">
        <a href="/" class="logo">Главная</a>
        <div class="tabs" id="tabs">
            {% for tab in tabs %}
                <div class="tab" onclick="window.location.href='{{ tab.url }}'">
                    {{ tab.name }} <span class="close" onclick="removeTab('{{ tab.name }}')">✖</span>
                </div>
            {% endfor %}
        </div>
        <div class="auth-links">
            {% if current_user.is_authenticated %}
                <a class="tbtt" href="/profile">Личный кабинет ({{ current_user.username }})</a>
                <a class="tbtt" href="/logout">Выйти</a>
            {% else %}
                <a class="tbtt" href="/login">Вход/Регистрация</a>
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
            <div class="user-name" id="user-name">
                {{ current_user.username }}
            </div>
            <div class="dropdown" id="user-dropdown" style="display: none;">
                <a href="/profile">Профиль</a>
                <a href="/logout">Выход</a>
            </div>
        {% endif %}
    </header>
    <script>
        document.querySelectorAll('.close').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the tab click event
                const tabName = this.previousElementSibling.textContent; // Get the tab title
                removeTab(tabName); // Call the function to remove the tab
            });
        });

        function removeTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            let tabIndex = -1;
        
            tabs.forEach((tab, index) => {
                if (tab.textContent.includes(tabName)) {
                    tabIndex = index;
                }
            });
        
            if (tabIndex !== -1) {
                fetch(`/api/del_tab/${tabIndex}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const tabToRemove = tabs[tabIndex];
                    tabToRemove.remove();
                    console.log('Updated tabs:', data);
                })
                .catch(error => {
                    console.error('Error removing tab:', error);
                });
            }
        }
    </script>
    <main>
        {% block content %}{% endblock %}
    </main>
    <script>
        const userName = document.getElementById('user-name');
        const userDropdown = document.getElementById('user-dropdown');

        userName.addEventListener('click', function() {
            userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
            userDropdown.style.left = `${userName.offsetLeft-100}px`; // Позиционируем по горизонтали
            userDropdown.style.top = `${userName.offsetTop + userName.offsetHeight}px`; // Позиционируем по вертикали
        });

        // Скрываем выпадающий список при уходе курсора с шапки или списка
        userName.addEventListener('mouseleave', function() {
            setTimeout(() => {
                if (!userDropdown.matches(':hover')) {
                    userDropdown.style.display = 'none';
                }
            }, 100); // Задержка для предотвращения мгновенного исчезновения
        });

        userDropdown.addEventListener('mouseleave', function() {
            userDropdown.style.display = 'none';
        });
    </script>
</body>
</html>